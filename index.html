<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FormCheck</title>
    
    <!-- AI Analysis Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>

    <style>
        :root {
            --primary-blue: #4089ff; 
            --primary-blue-hover: #3376e0;
            --active-green: #00e676;
            --record-red: #ff3b30;
            --dark-background: #1e1e1e;
            --medium-dark-background: #2b2b2b;
            --light-card-background: #3a3a3a;
            --text-color-light: #f0f0f0;
            --text-color-medium: #b0b0b0;
            --border-color: #4a4a4a;
            --shadow-color: rgba(0, 0, 0, 0.4);
        }

        #video1, #video2 { display: none; }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 8px;
            background-color: var(--dark-background);
            color: var(--text-color-light);
            line-height: 1.4;
            font-size: 14px;
        }

        button, input, select, textarea { font-family: inherit; }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: var(--medium-dark-background);
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 1px 3px var(--shadow-color);
            position: relative;
        }

        /* Title Area */
        .title-container {
            position: relative;
            text-align: center;
            margin-bottom: 5px;
        }

        h1 {
            display: inline-block;
            color: var(--primary-blue);
            margin: 5px 0 0 0;
            font-size: 2.1em;
            font-weight: 800;
            letter-spacing: 0.05em;
        }
        
        .subtitle {
            text-align: center;
            font-size: 0.8em;
            color: #888;
            margin: 0 0 15px 0;
            font-style: italic;
        }

        .info-btn {
            background: #555;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            font-weight: bold;
            font-family: serif;
            cursor: pointer;
            position: absolute;
            top: 10px;
            margin-left: 8px;
        }

        /* File Upload */
        .upload-section {
            background: var(--light-card-background);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            gap: 5px;
        }
        .file-input-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: #444;
            border-radius: 6px;
            height: 30px;
            border: 1px solid var(--border-color);
        }
        .file-input-wrapper input[type="file"] { 
            position: absolute; font-size: 100px; opacity: 0; right: 0; top: 0; cursor: pointer;
        }
        .file-input-wrapper span {
            display: flex; align-items: center; justify-content: center; height: 100%; font-size: 0.85em; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 5px;
        }

        /* Canvas */
        .video-output {
            margin-bottom: 8px;
            text-align: center;
            position: relative;
        }
        canvas {
            display: block;
            margin: 0 auto;
            background-color: #000;
            max-width: 100%;
            border-radius: 6px;
            touch-action: auto; 
            border: 2px solid var(--border-color);
        }

        #aiLoader, #recordingStatus {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: bold;
            display: none;
            pointer-events: none;
            z-index: 10;
            text-align: center;
        }

        /* Controls */
        .control-group {
            background-color: var(--light-card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 8px;
        }

        .tools-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
        }
        .tools-header h3 { margin: 0; font-size: 1em; color: var(--text-color-light); }
        .tool-buttons { display: flex; gap: 6px; }

        .video-row-header {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 5px;
            flex-wrap: nowrap;
        }
        .video-label {
            font-weight: 600;
            font-size: 0.9em;
            color: var(--text-color-light);
            min-width: 45px; 
        }
        .time-display {
            color: var(--primary-blue);
            font-weight: bold;
            margin-left: auto;
            font-size: 0.85em;
            min-width: 45px;
            text-align: right;
        }

        /* Buttons */
        .icon-btn {
            width: 32px;
            height: 32px;
            padding: 0;
            background-color: var(--primary-blue);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
            color: white;
            transition: background 0.2s;
        }
        .icon-btn.flat-icon { color: transparent; text-shadow: 0 0 0 white; }
        .icon-btn:hover { background-color: var(--primary-blue-hover); }
        .icon-btn.active { background-color: var(--active-green); box-shadow: 0 0 4px var(--active-green); }
        .icon-btn.loading { background-color: #ffea00; cursor: wait; }

        .trim-btn { background-color: #555; font-weight: bold; font-size: 1.0em; width: 28px; height: 32px; }

        input[type="range"] {
            display: block; width: 100%; height: 12px; cursor: pointer; -webkit-appearance: none; background: transparent; margin-top: 5px;
        }
        input[type="range"]::-webkit-slider-runnable-track { height: 12px; border-radius: 6px; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: white; 
            border: 2px solid var(--primary-blue); margin-top: -4px; box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        /* Global Controls */
        .global-controls {
            display: flex; gap: 10px; margin-top: 10px;
        }
        .global-btn {
            flex: 1; height: 60px; border-radius: 10px; border: none;
            background-color: var(--primary-blue); color: white;
            font-size: 1.8em; display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .global-btn.flat-icon { color: transparent; text-shadow: 0 0 0 white; }
        
        /* Save Button with Beta Tag */
        .global-btn.record-btn { 
            background-color: #444; 
            color: white; 
            font-size: 2.2em; 
            position: relative; 
        }
        .global-btn.record-btn.recording { background-color: var(--record-red); animation: pulse 1.5s infinite; }
        
        .beta-tag {
            position: absolute;
            top: 2px;
            right: 5px;
            font-size: 0.35em;
            background: #ffcc00;
            color: #000;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: bold;
            text-shadow: none;
        }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .annotation-toolbar {
            display: none; justify-content: center; gap: 10px; margin-top: 5px; padding-top: 5px; border-top: 1px solid #555;
        }
        .color-dot { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #555; cursor: pointer; }
        .color-dot.selected { border-color: white; transform: scale(1.2); }

        /* Modal / User Manual */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #fff; color: #333;
            width: 90%; max-width: 500px; max-height: 85vh;
            overflow-y: auto; padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
            font-size: 15px;
            line-height: 1.6;
        }
        .modal-content h2 { margin-top: 0; color: var(--primary-blue); border-bottom: 2px solid #eee; padding-bottom: 10px;}
        .modal-content h4 { margin: 15px 0 8px; color: #333; font-weight: bold; background: #f5f5f5; padding: 5px 10px; border-radius: 4px; }
        .modal-content ul { padding-left: 20px; margin: 5px 0; }
        .modal-content li { margin-bottom: 6px; }
        .close-modal {
            background: var(--primary-blue); color: white; border: none;
            padding: 10px 20px; border-radius: 6px; cursor: pointer;
            float: right; margin-top: 15px; font-weight: bold;
        }
        .close-modal:hover { background-color: var(--primary-blue-hover); }

        .sr-only { display: none; }
    </style>
</head>
<body>
    <!-- User Manual Modal -->
    <div id="helpModal" class="modal-overlay">
        <div class="modal-content">
            <h2>User Manual</h2>
            <p><strong>FormCheck</strong> helps you compare your form against a reference video using overlay, AI skeleton analysis, and annotations.</p>

            <h4>1. Setup</h4>
            <ul>
                <li><strong>Upload:</strong> Select a Reference Video (Video 1) and your Attempt (Video 2). You can use just one video if desired.</li>
                <li><strong>Opacity:</strong> Use the top slider to fade Video 2 in/out.</li>
            </ul>

            <h4>2. Adjusting Videos</h4>
            <ul>
                <li><strong>Move (‚ú•):</strong> Click this icon for a video, then drag on the canvas to move it, or pinch to resize/zoom it.</li>
                <li><strong>Trim ([ ]):</strong> Move the timeline slider to a point and click <strong>[</strong> to set Start or <strong>]</strong> to set End.</li>
                <li><strong>Bone (ü¶¥):</strong> Toggle AI Stick Figure overlay.</li>
            </ul>

            <h4>3. Annotation Tools</h4>
            <ul>
                <li><strong>Draw (‚úèÔ∏è):</strong> Select a color and draw lines.</li>
                <li><strong>Text (T):</strong> Tap to add text. Drag to move, pinch to resize.</li>
                <li><strong>Undo (‚Ü©):</strong> Remove the last action.</li>
            </ul>

            <h4>4. Saving</h4>
            <ul>
                <li><strong>Save (üíæ):</strong> Automatically plays your videos from start to finish and downloads a .webm video file.</li>
            </ul>

            <button class="close-modal" onclick="document.getElementById('helpModal').style.display='none'">Got it</button>
        </div>
    </div>

    <div class="container">
        <div class="title-container">
            <h1>FormCheck</h1>
            <button class="info-btn" onclick="document.getElementById('helpModal').style.display='flex'">i</button>
        </div>
        <p class="subtitle">by @wastingmytimehere</p>

        <div class="upload-section">
            <div class="file-input-wrapper">
                <input type="file" id="fileInput1" accept="video/*">
                <span id="fileName1">Upload Video 1...</span>
            </div>
            <div class="file-input-wrapper">
                <input type="file" id="fileInput2" accept="video/*">
                <span id="fileName2">Upload Video 2...</span>
            </div>
        </div>

        <div class="video-output">
            <canvas id="videoCanvas" width="640" height="360"></canvas>
            <div id="aiLoader">Initializing AI...</div>
            <div id="recordingStatus">
                <div style="font-size:1.2em; margin-bottom:5px;">Rendering Video...</div>
                <div style="font-size:0.9em; font-weight:normal;">Please wait while the video plays.</div>
            </div>
        </div>

        <div class="control-group">
            <div class="tools-header">
                <h3>Opacity & Tools</h3>
                <div class="tool-buttons">
                    <button id="drawBtn" class="icon-btn" aria-label="Draw">‚úèÔ∏è</button>
                    <button id="textBtn" class="icon-btn" aria-label="Text">T</button>
                    <button id="undoBtn" class="icon-btn" aria-label="Undo">‚Ü©</button>
                </div>
            </div>
            <div id="annotationToolbar" class="annotation-toolbar">
                <div class="color-dot selected" style="background: #ff3b30;" data-color="#ff3b30"></div>
                <div class="color-dot" style="background: #4cd964;" data-color="#4cd964"></div>
                <div class="color-dot" style="background: #007aff;" data-color="#007aff"></div>
                <div class="color-dot" style="background: #ffcc00;" data-color="#ffcc00"></div>
                <div class="color-dot" style="background: #ffffff;" data-color="#ffffff"></div>
            </div>
            
            <input type="range" id="opacitySlider" min="0" max="1" step="0.01" value="0.5" style="background: linear-gradient(to right, #555, #555);">
        </div>

        <div class="control-group">
            <div class="video-row-header">
                <span class="video-label">Video 1</span>
                <button id="moveV1Btn" class="icon-btn flat-icon" aria-label="Move">‚ú•</button>
                <button id="playPauseButton1" class="icon-btn flat-icon" aria-label="Play">‚ñ∂</button>
                <button id="restartButton1" class="icon-btn flat-icon" aria-label="Restart">‚Ü∫</button>
                <button id="boneBtn1" class="icon-btn bone-btn" aria-label="Bone">ü¶¥</button>
                <button id="setStart1" class="icon-btn trim-btn" aria-label="Start Trim">[</button>
                <button id="setEnd1" class="icon-btn trim-btn" aria-label="End Trim">]</button>
                <span id="timeValue1" class="time-display">0.00s</span>
            </div>
            <input type="range" id="timeSlider1" min="0" max="1" step="0.01" value="0" style="background: #444;">
        </div>

        <div class="control-group">
            <div class="video-row-header">
                <span class="video-label">Video 2</span>
                <button id="moveV2Btn" class="icon-btn flat-icon" aria-label="Move">‚ú•</button>
                <button id="playPauseButton2" class="icon-btn flat-icon" aria-label="Play">‚ñ∂</button>
                <button id="restartButton2" class="icon-btn flat-icon" aria-label="Restart">‚Ü∫</button>
                <button id="boneBtn2" class="icon-btn bone-btn" aria-label="Bone">ü¶¥</button>
                <button id="setStart2" class="icon-btn trim-btn" aria-label="Start Trim">[</button>
                <button id="setEnd2" class="icon-btn trim-btn" aria-label="End Trim">]</button>
                <span id="timeValue2" class="time-display">0.00s</span>
            </div>
            <input type="range" id="timeSlider2" min="0" max="1" step="0.01" value="0" style="background: #444;">
        </div>

        <div class="global-controls">
            <button id="syncAllStartsButton" class="global-btn flat-icon">‚èÆ</button>
            <button id="globalPlayPauseBtn" class="global-btn flat-icon">‚ñ∂ / ‚è∏</button>
            <button id="recordBtn" class="global-btn record-btn flat-icon">
                üíæ<span class="beta-tag">beta</span>
            </button>
        </div>
        
        <p id="status"></p>
    </div>

    <video id="video1" preload="auto" crossorigin="anonymous" playsinline webkit-playsinline></video>
    <video id="video2" preload="auto" crossorigin="anonymous" playsinline webkit-playsinline></video>

    <script src="app.js"></script>
</body>
</html>